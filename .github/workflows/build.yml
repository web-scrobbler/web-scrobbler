name: Build
on:
  push:
    branches: [master]
  pull_request:
    types: [opened, synchronize]
  # 添加手动触发选项
  workflow_dispatch:
    inputs:
      build-browser:
        description: '选择要构建的浏览器 (留空则构建所有)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chrome
          - firefox
          - safari

jobs:
  build-chrome:
    name: Build the extension for Chrome
    runs-on: ubuntu-latest
    # 添加条件，当手动触发时检查输入参数
    if: |
      github.event_name == 'push' || 
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.build-browser == 'all' || github.event.inputs.build-browser == 'chrome')
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build the extension
        run: |
          npm run build chrome

      - name: Upload the extension as an artifact
        if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: web-scrobbler-chrome
          path: build/chrome

  build-firefox:
    name: Build the extension for Firefox
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.build-browser == 'all' || github.event.inputs.build-browser == 'firefox')
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build the extension
        run: |
          npm run build firefox

      - name: Upload the extension as an artifact
        if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: web-scrobbler-firefox
          path: build/firefox

  build-safari:
    name: Build the extension for Safari
    runs-on: macos-13
    if: |
      github.event_name == 'push' || 
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' && 
      (github.event.inputs.build-browser == 'all' || github.event.inputs.build-browser == 'safari')
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install Os packages
        run: |
          brew install pango

      - name: Install dependencies
        run: npm ci

      - name: Build the extension
        run: |
          npm run build safari

      - name: Upload the extension as an artifact
        if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: web-scrobbler-safari
          path: build/safari
